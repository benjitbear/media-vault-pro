name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Nightly quality gate — also pings Healthchecks.io
    - cron: "30 4 * * *"

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.12"
  HEALTHCHECKS_PING_URL: ${{ secrets.HEALTHCHECKS_PING_URL }}  # https://hc-ping.com/<uuid>

jobs:
  # ─── Lint ────────────────────────────────────────────────────
  lint:
    name: Lint & Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install dev dependencies
        run: pip install -e ".[dev]"

      - name: Black (format check)
        run: black --check --diff src tests

      - name: isort (import order)
        run: isort --check-only --diff src tests

      - name: Flake8 (lint)
        run: flake8 src tests --max-line-length=100

      - name: Bandit (security scan)
        run: bandit -r src -c pyproject.toml

  # ─── Type Check ─────────────────────────────────────────────
  typecheck:
    name: Mypy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install dependencies
        run: pip install -e ".[dev,content]"

      - name: Mypy
        run: mypy src --ignore-missing-imports
        continue-on-error: true  # Non-blocking until type annotations are complete

  # ─── Test Matrix ────────────────────────────────────────────
  test:
    name: Test (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12"]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends ffmpeg mediainfo

      - name: Install project
        run: pip install -e ".[dev,content]"

      - name: Run tests with coverage
        run: |
          pytest \
            --cov=src \
            --cov-report=term-missing \
            --cov-report=xml:coverage.xml \
            --cov-report=html:htmlcov \
            --junitxml=junit.xml \
            -v

      - name: Upload coverage to Codecov
        if: matrix.python-version == '3.12' && github.event_name != 'schedule'
        uses: codecov/codecov-action@v4
        with:
          file: coverage.xml
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-py${{ matrix.python-version }}
          path: |
            junit.xml
            coverage.xml
            htmlcov/

  # ─── Docker Build ───────────────────────────────────────────
  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: [lint, test]
    if: github.event_name != 'schedule'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          load: true
          tags: medialibrary:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Smoke test container
        run: |
          docker run -d --name ml-smoke \
            -e FLASK_SECRET_KEY=test-secret \
            -e MEDIA_ROOT=/media \
            -p 8096:8096 \
            medialibrary:${{ github.sha }}

          # Wait for startup
          for i in $(seq 1 15); do
            if curl -sf http://localhost:8096/ > /dev/null 2>&1; then
              echo "✓ Container is healthy"
              break
            fi
            echo "Waiting... ($i/15)"
            sleep 2
          done

          # Verify health — show logs on failure
          if ! curl -sf http://localhost:8096/; then
            echo "=== Container logs ==="
            docker logs ml-smoke 2>&1 || true
            docker rm -f ml-smoke 2>/dev/null || true
            exit 1
          fi
          docker rm -f ml-smoke

  # ─── Healthchecks.io Ping ───────────────────────────────────
  healthcheck-ping:
    name: Healthchecks.io Ping
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test]
    if: always()
    steps:
      - name: Ping success
        if: needs.test.result == 'success' && needs.lint.result == 'success'
        run: curl -fsS -m 10 --retry 5 "$HEALTHCHECKS_PING_URL" || true

      - name: Ping failure
        if: needs.test.result == 'failure' || needs.lint.result == 'failure'
        run: curl -fsS -m 10 --retry 5 "$HEALTHCHECKS_PING_URL/fail" || true

  # ─── Deploy (on main only, requires production environment secrets) ──
  # deploy:
  #   name: Deploy
  #   runs-on: ubuntu-latest
  #   needs: [lint, typecheck, test, docker]
  #   if: github.ref == 'refs/heads/main' && github.event_name == 'push'
  #   environment: production
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Deploy via SSH
  #       uses: appleboy/ssh-action@v1
  #       with:
  #         host: ${{ secrets.DEPLOY_HOST }}
  #         username: ${{ secrets.DEPLOY_USER }}
  #         key: ${{ secrets.DEPLOY_SSH_KEY }}
  #         script: |
  #           cd ~/MediaLibrary
  #           git pull origin main
  #           docker compose pull || true
  #           docker compose up -d --build
  #           echo "✓ Deployed $(git rev-parse --short HEAD)"
